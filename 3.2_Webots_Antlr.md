# Webots + ANTLR

En el directorio del controlador hay que crear un fichero `runtime.ini`poniendo el path a la librería de ANTLR. La ruta debe ser absoluta.

```shell
[environment variables with paths]
CLASSPATH = /home/shiguera/ownCloud/AAA_Teleco/2024-25/3_TFG/
    ws/TestWebotsLanguage/libraries/antlr-4.13.1-complete.jar
```

El listener tiene que recibir una referencia al robot que se va a mover. Los métodos del listener llamarán a métodos del robot.

```java
import grammar.WebotsBaseListener;
import grammar.WebotsParser.SetVelocidadContext;


public class MyListener extends WebotsBaseListener {

    static SimpleVehicle robot;

    public MyListener(SimpleVehicle robot) {
        MyListener.robot = robot;
    }

    @Override
    public void enterSetVelocidad(SetVelocidadContext ctx) {
        double v = Double.parseDouble(ctx.VALUE().getText());
        System.out.println("Velocidad: " + v);
        robot.setVelocity(v);
    }
}
```

El controlador deberá arrancar el walker para leer el fichero con las instrucciones:

```java
import java.io.IOException;

import org.antlr.v4.runtime.CharStream;
import org.antlr.v4.runtime.CharStreams;
import org.antlr.v4.runtime.CommonTokenStream;
import org.antlr.v4.runtime.tree.ParseTree;
import org.antlr.v4.runtime.tree.ParseTreeWalker;

import grammar.WebotsLexer;
import grammar.WebotsParser;

public class SimpleController {
   static SimpleVehicle robot;

   public static void main(String[] args) throws Exception {
      // Con valores menores dde 32 he tenido errores 
      // que no conseguía comprender
      int TIME_STEP = 32;
      robot = new SimpleVehicle(TIME_STEP);

      initParser();

      //while (robot.step(TIME_STEP) != -1);  
   }
   static void initParser() throws IOException {
      CharStream input = CharStreams.fromFileName("instrucciones.txt");
      WebotsLexer lexer = new WebotsLexer(input);
      CommonTokenStream tokens = new CommonTokenStream(lexer);
      WebotsParser parser = new WebotsParser(tokens);
      ParseTree tree = parser.prog();
      ParseTreeWalker walker = new ParseTreeWalker();
      walker.walk(new MyListener(robot), tree);
   }
   static void printAngle() {
      System.out.println(robot.getBearingInDegrees());
   }
}
```

La estructura de ficheros:

![](/home/shiguera/ownCloud/Apuntes/img/tree_1.png)

Para crear el lexer y el parser, situado en el directorio `grammar`:

```shell
$> antlr Webots.g4
$> javac -cp .:/usr/local/webots/lib/controller/java/Controller.jar:
      /usr/local/lib/antlr-4.13.2-complete.jar *.java
```

Para compilar el Listener, que está en el directorio del controller:

```shell
$> javac -cp .:/usr/local/webots/lib/controller/java/Controller.jar:
      /usr/local/lib/antlr-4.13.2-complete.jar *.java
```

Para ejecutar el `TestRawListener`que he creado para pruebas, hay que situarse en el directorio del controller e invocar la ejecución con `grammar.TestRawListener`.
